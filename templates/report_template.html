<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>{{ brand }} 舆情分析仪表盘</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'PingFang SC', 'Microsoft YaHei', sans-serif; line-height: 1.6; margin: 0; background: #f7f8fa; }
    .header { padding: 16px 24px; border-bottom: 1px solid #e5e7eb; background: #fff; }
    .title { font-size: 18px; font-weight: 600; text-align: center; }
    .container { display: grid; grid-template-columns: 1fr 360px; gap: 12px; padding: 12px; }
    .panel { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; }
    .panel-body { padding: 12px 16px; }
    .metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .metric { background: #0f172a; color: #fff; border-radius: 8px; padding: 16px; }
    .metric .value { font-size: 20px; font-weight: 700; }
    .metric .label { font-size: 12px; opacity: 0.85; margin-top: 4px; }
    .section-title { font-weight: 600; margin: 12px 0 6px; }
    .card { border: 1px solid #eee; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
    .small { color: #666; }

    /* 右侧日志面板 */
    .console { background: #0b0f14; color: #22c55e; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 12px; }
    .console-header { display:flex; align-items:center; gap:6px; padding:8px 10px; border-bottom:1px solid #1f2937; color:#9ca3af; }
    .dot { width:6px; height:6px; border-radius:999px; background:#22c55e; display:inline-block; }
    .console-body { height: calc(100vh - 140px); overflow:auto; padding: 8px 10px; }
    .logline { white-space: pre-wrap; margin: 2px 0; }
  </style>
</head>
<body>
  <div class="header"><div class="title">致力于打造简洁通用的舆情分析平台</div></div>

  <div class="container">
    <!-- 左侧主内容 -->
    <div class="panel">
      <div class="panel-body">
        <div style="font-size:12px;color:#6b7280;">Report Engine · 智能报告生成</div>
        {% if docs|length == 0 %}
        <div class="card" style="background:#fff7ed;border-color:#fdba74;">
          <div style="font-weight:600;margin-bottom:6px;">当前为空报告</div>
          <div class="small" style="color:#92400e;">未检索到有效数据。可能原因：关键词过窄、时间窗过短、网络或公共实例不稳定。</div>
          <div class="small" style="color:#92400e;">建议：尝试更换/扩展关键词（例如：品牌+口碑/投诉/测评）、拉长时间窗，或稍后重试。</div>
        </div>
        {% endif %}
        <div class="metrics" style="margin-top:10px;">
          <div class="metric">
            <div class="value">≈{{ docs|length }}</div>
            <div class="label">有效文本样本</div>
          </div>
          <div class="metric">
            <div class="value">≈{{ (docs|length * 20) }}</div>
            <div class="label">抓取总量（估算）</div>
          </div>
          <div class="metric">
            <div class="value">≈{{ (insights.clusters|default([])|length * 80) }}</div>
            <div class="label">总帖子数（估算）</div>
          </div>
        </div>

        <div class="section-title">1.3 主要结论与策略展示</div>
        <div class="card">
          {% if synthesis.core_points %}
            {% for p in synthesis.core_points %}
              <div>• {{ p }}</div>
            {% endfor %}
          {% else %}
            <div>暂无整合结论</div>
          {% endif %}
        </div>

        <div class="section-title">2.0 品牌声量与影响力分析</div>
        <div class="card">
          <div style="font-weight:600;margin-bottom:8px;">2.1 整体声量趋势</div>
          <canvas id="trendChart" height="120"></canvas>
        </div>
        <div class="card">
          <div style="font-weight:600;margin-bottom:8px;">2.2 渠道声量分布</div>
          <canvas id="channelChart" height="120"></canvas>
        </div>

        <div class="section-title">3.0 关键词与话题</div>
        <div class="card">
          <div><strong>关键词：</strong> {{ insights.keywords|default([])|join(', ') }}</div>
        </div>
        <div class="card">
          <div style="font-weight:600;margin-bottom:8px;">话题聚类与样例</div>
          {% if insights.clusters %}
            {% for c in insights.clusters %}
              <div style="margin-bottom:8px;">
                <strong>主题 {{ c.label }}（样本 {{ c.size }}）</strong>
                <div class="small">示例：</div>
                {% for s in c.samples %}
                  <div class="small">- {{ s }}</div>
                {% endfor %}
              </div>
            {% endfor %}
          {% else %}
            <div class="small">暂无聚类信息</div>
          {% endif %}
        </div>

        <div class="section-title">来源样本（部分）</div>
        {% for d in docs[:15] %}
          <div class="card">
            <div><a href="{{ d.url }}" target="_blank">{{ d.url }}</a></div>
            <div class="small">发布日期：{{ d.published if d.published else '未知' }}</div>
            <div>{{ d.text[:200] }}...</div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- 右侧日志 -->
    <div class="panel console">
      <div class="console-header">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        <span>Insight Engine</span>
        <span class="dot" style="background:#10b981"></span><span>Media Engine</span>
        <span class="dot" style="background:#10b981"></span><span>Query Engine</span>
        <span class="dot" style="background:#10b981"></span><span>Forum Engine</span>
        <span class="dot" style="background:#10b981"></span><span>Report Engine</span>
      </div>
      <div class="console-body">
        {% for line in logs|default([]) %}
          <div class="logline">{{ line }}</div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- 数据注入，避免在 JS 代码中直接使用模板表达式导致解析器报错 -->
  <script id="trend-data" type="application/json">{{ insights.trend | default([]) | tojson | safe }}</script>
  <script id="channel-data" type="application/json">{{ insights.channels | default({}) | tojson | safe }}</script>
  <script>
    const parseJSON = (id, fallback) => {
      try {
        const el = document.getElementById(id);
        const txt = (el && el.textContent) ? el.textContent.trim() : '';
        return txt ? JSON.parse(txt) : fallback;
      } catch (e) {
        return fallback;
      }
    };
    const trendData = parseJSON('trend-data', []);
    const channelData = parseJSON('channel-data', {});

    // Trend chart
    (function(){
      const labels = (trendData || []).map(x => x.date);
      const values = (trendData || []).map(x => x.count);
      const ctx = document.getElementById('trendChart');
      if (ctx && labels.length) {
        new Chart(ctx, {
          type: 'line',
          data: { labels, datasets: [{ label: '声量', data: values, borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,0.15)', tension:0.2 }] },
          options: { scales: { y: { beginAtZero: true } } }
        });
      }
    })();
    // Channel chart
    (function(){
      const labels = Object.keys(channelData || {});
      const values = Object.values(channelData || {});
      const ctx = document.getElementById('channelChart');
      if (ctx && labels.length) {
        new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets: [{ label: '声量', data: values, backgroundColor:'#10b981' }] },
          options: { scales: { y: { beginAtZero: true } } }
        });
      }
    })();
  </script>
</body>
</html>